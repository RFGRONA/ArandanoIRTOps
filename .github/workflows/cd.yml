name: CD - Sync Server Configuration

on:
  push:
    branches:
      - 'main'
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  sync-server:
    name: Sync Server with Main Branch
    runs-on: ubuntu-latest
    
    environment:
      name: production
      url: https://arandanoirt.co

    steps:
      - name: Wait for approval and apply changes
        uses: appleboy/ssh-action@v1.2.2
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          fingerprint: ${{ secrets.SSH_FINGERPRINT }}
          script: |
            set -e

            echo "--- Synchronizing repository on the server ---"
            cd /home/${{ secrets.SSH_USERNAME }}/ArandanoProject/ArandanoIRTOps

            echo "--- Cleaning local repository to avoid merge conflicts ---"
            git fetch --all
            git reset --hard origin/main
            git clean -fd
            echo "--- Pulling latest changes from remote repository ---"
            git pull origin main

            echo "--- Applying Docker Compose configuration ---"
            # Apply changes and remove orphan containers
            docker compose up -d --remove-orphans

            echo "--- Synchronization completed successfully ---"